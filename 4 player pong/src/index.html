<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>4-játékos Pong</title>
<style>
  body {
    margin:0;
    font-family:system-ui,Segoe UI,Roboto;
    background:#0b1220;
    color:#dfe7ff;
    display:flex;
    flex-direction:column;
    height:100vh;
    overflow:hidden;
  }
  header {
    padding:10px 16px;
    display:flex;
    gap:12px;
    align-items:center;
    background:#071025;
    box-shadow:0 2px 6px rgba(0,0,0,.6);
    z-index:10;
  }
  header h1 { font-size:16px; margin:0; }
  #status { margin-left:auto; font-size:13px; opacity:.9; }
  #game-wrap {
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  canvas {
    background:#0b2a3a;
    border:6px solid #022539;
    border-radius:8px;
    width:100vw;
    height:100vh;
    object-fit:contain;
  }
</style>
</head>
<body>
<header>
  <h1>4-játékos Pong</h1>
  <div id="status">WS: <span id="ws-state">csatlakozás...</span></div>
</header>

<div id="game-wrap">
  <canvas id="game"></canvas>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

let wsUrl = "ws://raspberrypi.local:8080/4playerpong?type=display";
let socket = null;
let gameState = null;
let winnerMessage = null;
let winnerTimeout = null;

const colors = {1:"#75e0ff", 2:"#ffd57a", 3:"#9effa3", 4:"#ff9ecb"};

function resizeCanvas() {
  const headerH = document.querySelector("header").offsetHeight;
  canvas.width = Math.max(400, window.innerWidth);
  canvas.height = Math.max(300, window.innerHeight - headerH - 10);
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({
      type: "displaySize",
      width: canvas.width,
      height: canvas.height
    }));
  }
}
window.addEventListener('resize', () => { resizeCanvas(); draw(); });
resizeCanvas();

function tryConnect() {
  updateWSState('próbálkozás...');
  socket = new WebSocket(wsUrl);
  socket.onopen = () => {
    updateWSState('csatlakozva');
    socket.send(JSON.stringify({
      type: "displaySize",
      width: canvas.width,
      height: canvas.height
    }));
  };
  socket.onerror = () => updateWSState('hiba');
  socket.onclose = () => {
    updateWSState('kapcsolat bontva, újracsatlakozás...');
    setTimeout(() => location.reload(), 1200);
  };
  socket.onmessage = (ev) => {
    const msg = JSON.parse(ev.data);
    if (msg.type === "state") {
      gameState = msg;
    }

    if (msg.type === "hit") {
      // amikor paddle eltalálja
      sfxPaddleHit();
    }

    if (msg.type === "reset") {
      // amikor új labda indul
      sfxStart();
    }

    if (msg.type === "winner") {
      sfxScore();
      const winnerNames = {1:"Bal",2:"Jobb",3:"Felső",4:"Alsó"};
      winnerMessage = `${winnerNames[msg.id]} játékos nyert!`;
      if (winnerTimeout) clearTimeout(winnerTimeout);
      winnerTimeout = setTimeout(() => { winnerMessage = null; }, 3000);
    }
  };
}
tryConnect();

let scoreAnimations = {1:0,2:0,3:0,4:0}; // anim progresszió

socket.onmessage = (ev) => {
  const msg = JSON.parse(ev.data);

  if (msg.type === "state") {
    if (gameState && msg.scores) {
      for (let i=1;i<=4;i++) {
        if (msg.scores[i] !== gameState.scores[i]) {
          scoreAnimations[i] = 1.0; // indíts animációt
        }
      }
    }
    gameState = msg;
  }

  if (msg.type === "hit") sfxPaddleHit();
  if (msg.type === "reset") sfxStart();
  if (msg.type === "winner") {
    sfxScore();
    const winnerNames = {1:"Bal",2:"Jobb",3:"Felső",4:"Alsó"};
    winnerMessage = `${winnerNames[msg.id]} játékos nyert!`;
    if (winnerTimeout) clearTimeout(winnerTimeout);
    winnerTimeout = setTimeout(() => { winnerMessage = null; }, 3000);
  }
};

function drawScores(GOAL_MARGIN) {
  if (!gameState?.scores) return;

  ctx.fillStyle = "white";
  ctx.textAlign = "center";

  for (let i=1;i<=4;i++) {
    let scale = 1.3; // alapból 30%-kal nagyobb
    if (scoreAnimations[i] > 0) {
      scale *= 1 + 0.3 * scoreAnimations[i]; // animáció extra növekedés +30%
      scoreAnimations[i] -= 0.05; // lassan csökken
      if (scoreAnimations[i] < 0) scoreAnimations[i] = 0;
    }

    let x, y;
    if (i===1) { x = GOAL_MARGIN - 20; y = canvas.height/2 + 10; }
    if (i===2) { x = canvas.width - GOAL_MARGIN + 20; y = canvas.height/2 + 10; }
    if (i===3) { x = canvas.width/2; y = GOAL_MARGIN - 10; }
    if (i===4) { x = canvas.width/2; y = canvas.height - GOAL_MARGIN + 35; }

    ctx.save();
    ctx.translate(x, y);
    ctx.scale(scale, scale);
    ctx.font = "36px bold sans-serif"; // 28px helyett 36px
    ctx.fillText(gameState.scores[i] ?? 0, 0, 0);
    ctx.restore();
  }
}


function draw() {
   ctx.clearRect(0,0,canvas.width,canvas.height);

  const PADDLE_H = gameState?.paddles?.PADDLE_H ?? Math.floor(canvas.height * 0.30);
  const PADDLE_W = gameState?.paddles?.PADDLE_W ?? Math.floor(canvas.width * 0.18);
  const PADDLE_THICK = gameState?.paddles?.PADDLE_THICKNESS ?? Math.floor(Math.min(canvas.width, canvas.height) * 0.035);

  const GOAL_MARGIN = 50;

  let p1y = gameState?.players?.[1]?.y ?? (canvas.height/2 - PADDLE_H/2);
  let p2y = gameState?.players?.[2]?.y ?? (canvas.height/2 - PADDLE_H/2);
  let p3x = gameState?.players?.[3]?.x ?? (canvas.width/2 - PADDLE_W/2);
  let p4x = gameState?.players?.[4]?.x ?? (canvas.width/2 - PADDLE_W/2);

  let bx  = gameState?.ball?.x ?? canvas.width/2;
  let by  = gameState?.ball?.y ?? canvas.height/2;

  // --- Sarkok falai (2-2 rövid szakasz minden sarokban) ---
  const cornerSize = 120;
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 6;

  // bal felső
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(cornerSize, 0);
  ctx.moveTo(0, 0);
  ctx.lineTo(0, cornerSize);
  ctx.stroke();

  // jobb felső
  ctx.beginPath();
  ctx.moveTo(canvas.width, 0);
  ctx.lineTo(canvas.width - cornerSize, 0);
  ctx.moveTo(canvas.width, 0);
  ctx.lineTo(canvas.width, cornerSize);
  ctx.stroke();

  // bal alsó
  ctx.beginPath();
  ctx.moveTo(0, canvas.height);
  ctx.lineTo(cornerSize, canvas.height);
  ctx.moveTo(0, canvas.height);
  ctx.lineTo(0, canvas.height - cornerSize);
  ctx.stroke();

  // jobb alsó
  ctx.beginPath();
  ctx.moveTo(canvas.width, canvas.height);
  ctx.lineTo(canvas.width - cornerSize, canvas.height);
  ctx.moveTo(canvas.width, canvas.height);
  ctx.lineTo(canvas.width, canvas.height - cornerSize);
  ctx.stroke();

  // --- Paddle-ök beljebb tolva ---
  ctx.fillStyle = colors[1];
  ctx.fillRect(GOAL_MARGIN, p1y, PADDLE_THICK, PADDLE_H);
  if (gameState?.roles?.[1] === "AI") {
    ctx.fillStyle = "#000";
    ctx.font = "20px bold sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("AI", GOAL_MARGIN + PADDLE_THICK/2, p1y + PADDLE_H/2 + 6);
  }

  ctx.fillStyle = colors[2];
  ctx.fillRect(canvas.width - GOAL_MARGIN - PADDLE_THICK, p2y, PADDLE_THICK, PADDLE_H);
  if (gameState?.roles?.[2] === "AI") {
    ctx.fillStyle = "#000";
    ctx.font = "20px bold sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("AI", canvas.width - GOAL_MARGIN - PADDLE_THICK/2, p2y + PADDLE_H/2 + 6);
  }

  ctx.fillStyle = colors[3];
  ctx.fillRect(p3x, GOAL_MARGIN, PADDLE_W, PADDLE_THICK);
  if (gameState?.roles?.[3] === "AI") {
    ctx.fillStyle = "#000";
    ctx.font = "20px bold sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("AI", p3x + PADDLE_W/2, GOAL_MARGIN + PADDLE_THICK/2 + 6);
  }

  ctx.fillStyle = colors[4];
  ctx.fillRect(p4x, canvas.height - GOAL_MARGIN - PADDLE_THICK, PADDLE_W, PADDLE_THICK);
  if (gameState?.roles?.[4] === "AI") {
    ctx.fillStyle = "#000";
    ctx.font = "20px bold sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("AI", p4x + PADDLE_W/2, canvas.height - GOAL_MARGIN - PADDLE_THICK/2 + 6);
  }

  // --- Labda ---
  ctx.fillStyle = "white";
  ctx.beginPath();
  ctx.arc(bx, by, 20, 0, Math.PI*2);
  ctx.fill();

// --- Pontok a kapunyílásoknál ---
if (gameState?.scores) {
  ctx.fillStyle = "white";
  ctx.font = "28px bold sans-serif";
  ctx.textAlign = "center";
  // felső
  ctx.fillText(gameState.scores[3] ?? 0, canvas.width/2, GOAL_MARGIN - 10);
  // alsó
  ctx.fillText(gameState.scores[4] ?? 0, canvas.width/2, canvas.height - GOAL_MARGIN + 35);
  // bal
  ctx.fillText(gameState.scores[1] ?? 0, GOAL_MARGIN - 20, canvas.height/2 + 10);
  // jobb
  ctx.fillText(gameState.scores[2] ?? 0, canvas.width - GOAL_MARGIN + 20, canvas.height/2 + 10);
}


  drawScores(GOAL_MARGIN);

  if (winnerMessage) {
    ctx.fillStyle = "yellow";
    ctx.font = "36px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText(winnerMessage, canvas.width/2, canvas.height/2);
  }

  requestAnimationFrame(draw);
}
draw();

function updateWSState(s){ document.getElementById('ws-state').textContent = s; }
</script>
</body>
</html>
